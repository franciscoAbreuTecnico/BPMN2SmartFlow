@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sf: <http://example.org/ontologies/SmartFlow#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@base <http://example.org/mappings/> .


#################################################################
# Map StartNode
#################################################################
<#StartNodeMapping>
  a rml:TriplesMap;
  rml:logicalSource [
    rml:source "{{JSON_SOURCE}}";
    rml:referenceFormulation ql:JSONPath;
    rml:iterator "$.flowTemplate.config.actionNodes[0]";
  ];

  rr:subjectMap [
    rr:template "http://example.org/ontologies/SmartFlow/StartNode/start-node" ;
    rr:termType rr:IRI ;
    rr:class sf:StartNode ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate rdf:type;
    rr:objectMap [ rr:constant sf:StartNode ];
  ];

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rr:template "start-event" ;
      rr:termType rr:Literal ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfName ;
    rr:objectMap [
      rr:template "Start Event" ;
      rr:termType rr:Literal ;
    ];
  ] ;

    rr:predicateObjectMap [
    rr:predicate sf:has_queue ;
    rr:objectMap [
      rr:template   "http://example.org/ontologies/SmartFlow/Queue/{queue}" ;
      rr:termType   rr:IRI ;
    ] ;
  ] ;

  rr:predicateObjectMap [
      rr:predicate sf:has_action ;
      rr:objectMap [
        rr:template "http://example.org/ontologies/SmartFlow/Action/START-start-event" ;
        rr:termType rr:IRI ;
      ] ;
  ];
.

<#StartNodeActionMapping>
  a rml:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    # iterate once over the entire JSON (so we can pick out actionNodes[0]):
    rml:iterator          "$" ;
  ] ;

  rr:subjectMap [
    rr:template   "http://example.org/ontologies/SmartFlow/Action/START-start-event" ;
    rr:termType   rr:IRI ;
    rr:class      sf:Action ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rr:constant "START-start-event" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfName ;
    rr:objectMap [
      rr:constant "START" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:isPrimaryAction ;
    rr:objectMap [
      rr:datatype xsd:boolean ;
      rr:constant "true" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:labelPT ;
    rr:objectMap [
      rr:constant "Iniciar Processo" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:labelEN ;
    rr:objectMap [
      rr:constant "Start Process" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_transitionsTo ;
    rr:objectMap [
      # Here is the single rr:template that “grabs” actionNodes[0].id
      rr:template   "http://example.org/ontologies/SmartFlow/ActionNode/{.flowTemplate.config.actionNodes[0].id}" ;
      rr:termType   rr:IRI ;
    ] ;
  ] ;
.

#################################################################
# Map each ActionNode
#################################################################
<#ActionNodeMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator "$.flowTemplate.config.actionNodes[*]" ;
  ] ;

  rr:subjectMap [
    rr:template "http://example.org/ontologies/SmartFlow/ActionNode/{id}" ;
    rr:termType rr:IRI ;
    rr:class sf:ActionNode ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rml:reference "id" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate   rdf:type ;
    rr:objectMap   [ rr:constant sf:ActionNode ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfName ;
    rr:objectMap [
      rml:reference "title.en-GB" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:titlePT ;
    rr:objectMap [
      rml:reference "title.pt-PT" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:titleEN ;
    rr:objectMap [
      rml:reference "title.en-GB" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:descriptionPT ;
    rr:objectMap [
      rml:reference "description.pt-PT" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:descriptionEN ;
    rr:objectMap [
      rml:reference "description.en-GB" ;
    ] ;
  ] ;
 
  rr:predicateObjectMap [
    rr:predicate sf:has_action ;
    rr:objectMap [
      rr:template "http://example.org/ontologies/SmartFlow/Action/{actions[*].id}" ;
      rr:termType rr:IRI ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_button ;
    rr:objectMap [
      rr:template    "http://example.org/ontologies/SmartFlow/Button/{buttons[*].id}" ;
      rr:termType    rr:IRI ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_actionProcessor ;
    rr:objectMap [
      rr:template    "http://example.org/ontologies/SmartFlow/ActionProcessor/{actionProcessor[*].id}" ;
      rr:termType    rr:IRI ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_queue ;
    rr:objectMap [
      rr:template   "http://example.org/ontologies/SmartFlow/Queue/{queue}" ;
      rr:termType   rr:IRI ;
    ] ;
  ] ;

  # rr:predicateObjectMap [
  #   rr:predicate sf:has_queue ;
  #   rr:objectMap [
  #     rr:parentTriplesMap <#QueueMapping> ;
  #     rr:joinCondition [
  #       rr:child  "queue" ;
  #       rr:parent "queue"
  #     ] ;
  #   ] ;
  # ] ;
.

<#GenericActionNodeMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    # filter so only type=="generic"
    rml:iterator          "$.flowTemplate.config.actionNodes[?(@.type=='generic')]" ;
  ] ;

  rr:subjectMap [
    rr:template   "http://example.org/ontologies/SmartFlow/ActionNode/{id}" ;
    rr:termType   rr:IRI ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate   rdf:type ;
    rr:objectMap   [ rr:constant sf:GenericActionNode ] ;
  ] ;
.
<#WithFormsActionNodeMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator          "$.flowTemplate.config.actionNodes[?(@.type=='withForms')]" ;
  ] ;

  rr:subjectMap [
    rr:template   "http://example.org/ontologies/SmartFlow/ActionNode/{id}" ;
    rr:termType   rr:IRI ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate   rdf:type ;
    rr:objectMap   [ rr:constant sf:WithFormsActionNode ] ;
  ] ;
.
<#WithButtonsActionNodeMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator          "$.flowTemplate.config.actionNodes[?(@.type=='withButtons')]" ;
  ] ;

  rr:subjectMap [
    rr:template   "http://example.org/ontologies/SmartFlow/ActionNode/{id}" ;
    rr:termType   rr:IRI ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate   rdf:type ;
    rr:objectMap   [ rr:constant sf:WithButtonsActionNode ] ;
  ] ;
.

#################################################################
# Map each TerminalNode (e.g. SUCCESS, FAILURE, CANCEL)
#################################################################
<#TerminalNodeMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator "$.flowTemplate.config.actionNodes[*].actions[?(@.to=='SUCCESS' || @.to=='FAILURE' || @.to=='CANCEL')]" ;
  ] ;

  rr:subjectMap [
    rr:template   "http://example.org/ontologies/SmartFlow/ActionNode/{to}" ;
    rr:termType   rr:IRI ;
        rr:class      sf:TerminalNode ;
  ] ;

  # rr:predicateObjectMap [
  #   rr:predicate   rdf:type ;
  #   rr:objectMap   [ rr:constant sf:TerminalNode ] ;
  # ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_queue ;
    rr:objectMap [
      rr:template   "http://example.org/ontologies/SmartFlow/Queue/{queue}" ;
      rr:termType   rr:IRI ;
    ] ;
  ] ;

  # rr:predicateObjectMap [
  #   rr:predicate sf:has_queue ;
  #   rr:objectMap [
  #     rr:parentTriplesMap <#QueueMapping> ;
  #     rr:joinCondition [
  #       rr:child  "queue" ;
  #       rr:parent "queue"
  #     ] ;
  #   ] ;
  # ] ;

  rr:predicateObjectMap [
    rr:predicate   sf:sfId ;
    rr:objectMap   [ rml:reference "to" ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate   sf:sfName ;
    rr:objectMap [
      rr:template   "{to} State" ;
      rr:termType   rr:Literal ;
    ] ;
  ] ;
.


#################################################################
# Map each Action associated with an ActionNode
#################################################################
<#ActionsMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator          "$.flowTemplate.config.actionNodes[*].actions[*]" ;
  ] ;

  rr:subjectMap [
    rr:template  "http://example.org/ontologies/SmartFlow/Action/{id}" ;
    rr:termType  rr:IRI ;
    rr:class     sf:Action ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rml:reference "id" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfName ;
    rr:objectMap [
      rml:reference "name" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:isPrimaryAction ;
    rr:objectMap [
      rml:reference "primary" ;
      rr:datatype   xsd:boolean ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:labelPT ;
    rr:objectMap [
      rml:reference "label.pt-PT" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:labelEN ;
    rr:objectMap [
      rml:reference "label.en-GB" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_transitionsTo ;
    rr:objectMap [
      rr:template    "http://example.org/ontologies/SmartFlow/ActionNode/{to}" ;
      rr:termType    rr:IRI ;
    ] ;
  ] ;
.


#################################################################
# Map each Button associated with an ActionNode
#################################################################
<#ButtonMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator          "$.flowTemplate.config.actionNodes[*].buttons[*]" ;
  ] ;

  rr:subjectMap [
    rr:template  "http://example.org/ontologies/SmartFlow/Button/{id}" ;
    rr:termType  rr:IRI ;
    rr:class     sf:Button ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rml:reference "id" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:isPrimaryButton ;
      rr:objectMap [
        rml:reference "primary" ;
        rr:datatype   xsd:boolean ;
      ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:labelPT ;
    rr:objectMap [
      rml:reference "label.pt-PT" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:labelEN ;
    rr:objectMap [
      rml:reference "label.en-GB" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_handlersAction ;
    rr:objectMap [
      rr:template "http://example.org/ontologies/SmartFlow/Action/{handlers.action}" ;
      rr:termType rr:IRI ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_associatedForm ;
    rr:objectMap [
      rr:template "http://example.org/ontologies/SmartFlow/Form/{handlers.form}" ;
      rr:termType rr:IRI ;
    ] ;
  ] ;
.

#################################################################
# Map each ActionProcessor associated with an ActionNode
#################################################################
<#ActionProcessorMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator "$.flowTemplate.config.actionNodes[*].actionProcessor[*]" ;
  ] ;

  rr:subjectMap [
    rr:template  "http://example.org/ontologies/SmartFlow/ActionProcessor/{id}" ;
    rr:termType  rr:IRI ;
    rr:class     sf:ActionProcessor ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rml:reference "id" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:has_applyOn ;
    rr:objectMap [
      rr:template "http://example.org/ontologies/SmartFlow/Action/{applyOn}" ;
      rr:termType rr:IRI ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfName ;
    rr:objectMap [
      rml:reference "flowProcessor" ;
    ] ;
  ] ;
.

#################################################################
# Map each Flow Form
#################################################################
<#FormMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator "$.flowTemplate.config.forms[*]" ;
  ] ;

  rr:subjectMap [
    rr:template  "http://example.org/ontologies/SmartFlow/Form/{id}" ;
    rr:termType  rr:IRI ;
    rr:class     sf:Form ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rml:reference "id" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:titlePT ;
    rr:objectMap [
      rml:reference "title.pt-PT" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:titleEN ;
    rr:objectMap [
      rml:reference "title.en-GB" ;
    ] ;
  ] ;
.

<#QueueMapping>
  a rr:TriplesMap ;
  rml:logicalSource [
    rml:source            "{{JSON_SOURCE}}" ;
    rml:referenceFormulation ql:JSONPath ;
    rml:iterator          "$.flowTemplate.config.actionNodes[*]" ;
  ] ;

  rr:subjectMap [
    rr:template   "http://example.org/ontologies/SmartFlow/Queue/{queue}" ;
    rr:termType   rr:IRI ;
    rr:class      sf:Queue ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate sf:sfId ;
    rr:objectMap [
      rml:reference "queue" ;
    ] ;
  ] ;

  rr:predicateObjectMap [
    rr:predicate  sf:sfName ;
    rr:objectMap  [ rml:reference "queue" ] ;
  ] ;
.
